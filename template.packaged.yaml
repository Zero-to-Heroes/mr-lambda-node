AWSTemplateFormatVersion: '2010-09-09'
Description: Map-reduce implentation using Lambda, S3 and SQS in Node
Globals:
  Function:
    Environment:
      Variables:
        S3_BUCKET:
          Ref: S3MRBucket
        SQS_AGGREGATOR_TRIGGER_URL:
          Ref: SQSAggregatorTriggerQueue
        SQS_AGGREGATOR_WATCHER_URL:
          Ref: SQSAggregatorWatcherQueue
        SQS_MAPPER_URL:
          Ref: SQSMapperInputQueue
        SQS_MAPPER_WATCHER_URL:
          Ref: SQSMapperWatcherQueue
        SQS_REDUCER_URL:
          Ref: SQSReducerInputQueue
        SQS_REDUCER_WATCHER_URL:
          Ref: SQSReducerWatcherQueue
Resources:
  AggregatorFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/26590147560b8c628079a2b68ee737c8
      Events:
        SQSAggregatorRequestedEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSAggregatorTriggerQueue
              - Arn
          Type: SQS
      Handler: reducer/reducer.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
    Type: AWS::Serverless::Function
  AggregatorWatcherFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/ab8b9f6269ab8b50fe9dc5838f9c5b4a
      Events:
        SQSAggregatorWatcherEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSAggregatorWatcherQueue
              - Arn
          Type: SQS
      Handler: aggregator-watcher/aggregator-watcher.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
    Type: AWS::Serverless::Function
  DriverFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/472dc2c63401206eda3debff8ccda5c8
      Handler: driver/driver.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 360
      Tracing: Active
    Type: AWS::Serverless::Function
  MapperFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/5f9bab4bae5bf38528595b33fd0653a1
      Events:
        SQSMapperRequestedEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSMapperInputQueue
              - Arn
          Type: SQS
      Handler: mapper/mapper.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
    Type: AWS::Serverless::Function
  MapperWatcherFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/6804287840936e2641ec3965bdbb2d4c
      Events:
        SQSAggregatorWatcherEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSMapperWatcherQueue
              - Arn
          Type: SQS
      Handler: mapper-watcher/mapper-watcher.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
      Tracing: Active
    Type: AWS::Serverless::Function
  ReducerFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/26590147560b8c628079a2b68ee737c8
      Events:
        SQSReducerRequestedEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSReducerInputQueue
              - Arn
          Type: SQS
      Handler: reducer/reducer.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
    Type: AWS::Serverless::Function
  ReducerWatcherFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/0fc4711abb018121c0851c4b64d130a7
      Events:
        SQSAggregatorWatcherEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSReducerWatcherQueue
              - Arn
          Type: SQS
      Handler: reducer-watcher/reducer-watcher.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
      Tracing: Active
    Type: AWS::Serverless::Function
  S3MRBucket:
    Properties:
      BucketName: com.zerotoheroes.mr
    Type: AWS::S3::Bucket
  SQSAggregatorTriggerQueue:
    Properties:
      QueueName: mr-sqs-aggregator-trigger
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSAggregatorWatcherQueue:
    Properties:
      QueueName: mr-sqs-aggregator-watcher
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSMapperInputQueue:
    Properties:
      QueueName: mr-sqs-mapper
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSMapperWatcherQueue:
    Properties:
      QueueName: mr-sqs-mapper-watcher
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSReducerInputQueue:
    Properties:
      QueueName: mr-sqs-reducer
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSReducerWatcherQueue:
    Properties:
      QueueName: mr-sqs-reducer-watcher
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
Transform: AWS::Serverless-2016-10-31
