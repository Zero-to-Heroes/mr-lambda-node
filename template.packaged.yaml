AWSTemplateFormatVersion: '2010-09-09'
Description: Map-reduce implentation using Lambda, S3 and SQS in Node
Globals:
  Function:
    Environment:
      Variables:
        S3_BUCKET:
          Ref: S3MRBucket
        SQS_AGGREGATOR_TRIGGER_URL:
          Ref: SQSAggregatorTriggerQueue
        SQS_AGGREGATOR_WATCHER_URL:
          Ref: SQSAggregatorWatcherQueue
        SQS_MAPPER_URL:
          Ref: SQSMapperInputQueue
        SQS_MAPPER_WATCHER_URL:
          Ref: SQSMapperWatcherQueue
        SQS_REDUCER_URL:
          Ref: SQSReducerInputQueue
        SQS_REDUCER_WATCHER_URL:
          Ref: SQSReducerWatcherQueue
Resources:
  AggregatorFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/7559ac6bdcc0968027b41026d4be7c3b
      Events:
        SQSAggregatorRequestedEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSAggregatorTriggerQueue
              - Arn
          Type: SQS
      Handler: reducer/reducer.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
    Type: AWS::Serverless::Function
  AggregatorWatcherFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/c0a25f9f7875d6b9304d3f553881ccc7
      Events:
        SQSAggregatorWatcherEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSAggregatorWatcherQueue
              - Arn
          Type: SQS
      Handler: aggregator-watcher/aggregator-watcher.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
    Type: AWS::Serverless::Function
  DriverFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/b9e4fd313be14694e3cf2840a2bdd9de
      Handler: driver/driver.default
      MemorySize: 2048
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 360
      Tracing: Active
    Type: AWS::Serverless::Function
  MapperFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/d86653da98a3fd0b504f4031fcc16d6b
      Events:
        SQSMapperRequestedEvent:
          Properties:
            BatchSize: 5
            Queue:
              Fn::GetAtt:
              - SQSMapperInputQueue
              - Arn
          Type: SQS
      Handler: mapper/mapper.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
    Type: AWS::Serverless::Function
  MapperWatcherFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/2449d1d78df566fa9c8ed9a6444b0b9b
      Events:
        SQSAggregatorWatcherEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSMapperWatcherQueue
              - Arn
          Type: SQS
      Handler: mapper-watcher/mapper-watcher.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
      Tracing: Active
    Type: AWS::Serverless::Function
  ReducerFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/7559ac6bdcc0968027b41026d4be7c3b
      Events:
        SQSReducerRequestedEvent:
          Properties:
            BatchSize: 10
            Queue:
              Fn::GetAtt:
              - SQSReducerInputQueue
              - Arn
          Type: SQS
      Handler: reducer/reducer.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
    Type: AWS::Serverless::Function
  ReducerWatcherFunction:
    Properties:
      CodeUri: s3://com.zerotoheroes.artifact/aeb217263dea1a6400e8db952a986d3a
      Events:
        SQSAggregatorWatcherEvent:
          Properties:
            BatchSize: 1
            Queue:
              Fn::GetAtt:
              - SQSReducerWatcherQueue
              - Arn
          Type: SQS
      Handler: reducer-watcher/reducer-watcher.default
      MemorySize: 512
      Policies:
      - AWSLambdaVPCAccessExecutionRole
      - SecretsManagerReadWrite
      - AmazonSESFullAccess
      - AmazonSNSReadOnlyAccess
      - AmazonSQSFullAccess
      - AmazonS3FullAccess
      Runtime: nodejs10.x
      Timeout: 600
      Tracing: Active
    Type: AWS::Serverless::Function
  S3MRBucket:
    Properties:
      BucketName: com.zerotoheroes.mr
    Type: AWS::S3::Bucket
  SQSAggregatorTriggerQueue:
    Properties:
      QueueName: mr-sqs-aggregator-trigger
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSAggregatorWatcherQueue:
    Properties:
      QueueName: mr-sqs-aggregator-watcher
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSMapperInputQueue:
    Properties:
      QueueName: mr-sqs-mapper
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSMapperWatcherQueue:
    Properties:
      QueueName: mr-sqs-mapper-watcher
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSReducerInputQueue:
    Properties:
      QueueName: mr-sqs-reducer
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
  SQSReducerWatcherQueue:
    Properties:
      QueueName: mr-sqs-reducer-watcher
      VisibilityTimeout: 601
    Type: AWS::SQS::Queue
Transform: AWS::Serverless-2016-10-31
